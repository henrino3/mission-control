<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mission Control üë©‚ÄçüöÄ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      color: #e0e0e0;
    }
    
    /* Header */
    .header {
      padding: 20px 30px 12px;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-icon {
      font-size: 24px;
    }
    .header h1 {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
    }
    .header-subtitle {
      font-size: 12px;
      color: #7c7c7c;
      margin-top: 4px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-gear {
      background: transparent;
      border: 1px solid #222;
      color: #999;
      font-size: 18px;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .header-gear:hover {
      color: #fff;
      border-color: #333;
      background: #111;
    }
    
    /* Global Search */
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .search-icon {
      background: transparent;
      border: 1px solid #222;
      color: #999;
      font-size: 16px;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .search-icon:hover {
      color: #fff;
      border-color: #333;
      background: #111;
    }
    .search-input {
      background: #111;
      border: 1px solid #333;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      width: 200px;
      font-size: 14px;
    }
    .search-input:focus {
      outline: none;
      border-color: #0af;
    }
    .search-clear {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 14px;
      position: absolute;
      right: 50px;
    }
    .search-results {
      position: absolute;
      top: 100%;
      right: 0;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      width: 350px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 8px;
    }
    .search-result {
      padding: 12px;
      border-bottom: 1px solid #222;
      cursor: pointer;
    }
    .search-result:hover {
      background: #222;
    }
    .search-result:last-child {
      border-bottom: none;
    }
    .search-result-title {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }
    .search-result-snippet {
      font-size: 12px;
      color: #888;
    }
    .search-result-snippet mark {
      background: #3a3a00;
      color: #ff0;
    }
    .search-no-results {
      padding: 20px;
      text-align: center;
      color: #666;
    }
    
    /* Filters */
    .filters {
      padding: 12px 30px 10px;
      border-bottom: 1px solid #222;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .board-tabs {
      display: flex;
      gap: 10px;
    }
    .board-tab {
      background: transparent;
      border: 1px solid #222;
      color: #777;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .board-tab.active {
      background: #5b5eef;
      border-color: #5b5eef;
      color: #fff;
    }
    .board-tab:hover {
      border-color: #333;
      color: #ddd;
    }
    .filter-btn {
      background: #5b5eef;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .filter-btn:hover { background: #4b4edf; }
    .filter-btn.secondary {
      background: transparent;
      color: #999;
    }
    .filter-btn.secondary:hover {
      background: #1a1a1a;
      color: #fff;
    }
    .filter-btn.active {
      background: #5b5eef;
      color: #fff;
    }
    .recurring-filter {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #999;
      font-size: 14px;
    }
    .recurring-dot {
      width: 8px;
      height: 8px;
      background: #8b5cf6;
      border-radius: 50%;
    }
    .recurring-count {
      font-size: 12px;
      color: #666;
    }
    
    /* Columns header */
    .columns-header {
      padding: 20px 30px 10px;
      display: grid;
      grid-template-columns: repeat(5, minmax(280px, 1fr));
      gap: 16px;
      overflow-x: auto;
    }
    .columns-header.show-archive {
      grid-template-columns: repeat(6, minmax(280px, 1fr));
    }
    .column-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #999;
    }
    .column-count {
      background: #1a1a1a;
      color: #fff;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }
    
    /* Board */
    .board {
      display: grid;
      grid-template-columns: repeat(5, minmax(280px, 1fr));
      gap: 16px;
      padding: 10px 30px 30px;
      overflow-x: auto;
    }
    .board.show-archive {
      grid-template-columns: repeat(6, minmax(280px, 1fr));
    }
    .strategic-board {
      display: none;
      gap: 20px;
      padding: 20px 30px 30px;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
    }
    .strategic-panel {
      background: #0d0d0d;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 16px;
      min-height: 420px;
    }
    .strategic-panel h4 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #666;
      margin-bottom: 14px;
    }
    .strategic-empty {
      color: #555;
      font-size: 14px;
    }
    /* Agents Dashboard */
    .agents-board {
      padding: 20px 30px;
    }
    .agents-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .agents-header h3 {
      margin: 0;
      font-size: 18px;
    }
    .agents-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .agent-lane {
      background: #0d0d0d;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 16px;
      min-height: 400px;
    }
    .agent-lane-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #222;
    }
    .agent-avatar {
      font-size: 24px;
    }
    .agent-name {
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }
    .agent-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      background: #222;
      color: #888;
    }
    .agent-status.working {
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
    }
    .agent-status.idle {
      background: #222;
      color: #666;
    }
    .agent-status.blocked {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }
    .agent-current-task {
      background: #111;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    .agent-current-task a {
      color: #3b82f6;
      text-decoration: none;
    }
    .agent-activity-log {
      font-size: 12px;
      color: #888;
      max-height: 280px;
      overflow-y: auto;
    }
    .agent-log-entry {
      padding: 8px 0;
      border-bottom: 1px solid #1a1a1a;
    }
    .agent-log-entry:last-child {
      border-bottom: none;
    }
    .agent-log-time {
      color: #555;
      font-size: 10px;
    }
    .agent-log-tool {
      color: #3b82f6;
      font-weight: 500;
    }
    .column {
      min-height: 500px;
      min-width: 280px;
    }
    
    /* Columns header scroll sync */
    .columns-header {
      overflow-x: auto;
    }
    .column-header.archive-column {
      display: none;
    }
    .columns-header.show-archive .column-header.archive-column {
      display: flex;
    }
    .column.archive-column {
      display: none;
    }
    .board.show-archive .column.archive-column {
      display: block;
    }
    .archive-toggle {
      cursor: pointer;
      opacity: 0.6;
    }
    .archive-toggle:hover {
      opacity: 1;
    }
    .archive-toggle.active {
      opacity: 1;
    }
    .task {
      background: #111;
      border: 1px solid #222;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      cursor: grab;
      transition: all 0.2s;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      position: relative;
    }
    .task:hover {
      background: #1a1a1a;
      border-color: #333;
    }
    .task.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .task.working {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6, 0 8px 24px rgba(59, 130, 246, 0.2);
    }
    .task.blocked {
      animation: blockedPulse 1.5s ease-in-out infinite;
    }
    @keyframes blockedPulse {
      0%, 100% { border-color: #ef4444; box-shadow: 0 0 0 1px #ef4444, 0 8px 24px rgba(239, 68, 68, 0.15); }
      50% { border-color: #dc2626; box-shadow: 0 0 8px 2px #ef4444, 0 8px 24px rgba(239, 68, 68, 0.3); }
    }
    .working-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
    }
    .working-indicator::after {
      content: '';
      display: block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .blocked-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 16px;
      animation: blockedBlink 0.8s ease-in-out infinite;
    }
    @keyframes blockedBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .task-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 8px;
    }
    .task-name {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      line-height: 1.4;
    }
    .recurring-badge {
      width: 6px;
      height: 6px;
      background: #8b5cf6;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 6px;
    }
    .task-desc {
      font-size: 13px;
      color: #888;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .task-status {
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 6px;
      margin: 8px 0;
      line-height: 1.4;
    }
    .task-status.working-status {
      background: rgba(59, 130, 246, 0.15);
      color: #93c5fd;
      border-left: 3px solid #3b82f6;
    }
    .task-status.blocked-status {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border-left: 3px solid #ef4444;
    }
    .task-status .time-ago {
      color: #666;
      font-size: 10px;
    }
    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #666;
      margin-top: 6px;
    }
    .task-meta-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .priority-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
    }
    .priority-p0 { background: #5b5eef; color: #fff; }
    .priority-p1 { background: #7c3aed; color: #fff; }
    .priority-p2 { background: #1f2937; color: #9ca3af; border: 1px solid #374151; }
    .priority-p3 { background: #0f172a; color: #6b7280; border: 1px dashed #334155; }
    .assignee-pill {
      background: #1a1a1a;
      padding: 4px 8px;
      border-radius: 8px;
      color: #ddd;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #222;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    .status-backlog { background: #4b5563; }
    .status-todo { background: #6b7280; }
    .status-doing { background: #0ea5e9; }
    .status-review { background: #f59e0b; }
    .status-done { background: #10b981; }
    .status-archive { background: #6b7280; opacity: 0.7; }
    .status-blocked { background: #ef4444; }
    .pill {
      border: 1px solid #222;
      background: #0f172a;
      color: #cbd5e1;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .summary-bar {
      padding: 10px 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      border-bottom: 1px solid #111;
      background: linear-gradient(90deg, rgba(42,42,63,0.45), rgba(16,16,24,0.65));
    }
    .panel {
      background: #0f0f12;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 14px;
      color: #cbd5e1;
    }
    .panel h4 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #6b7280;
      margin-bottom: 10px;
    }
    .project-dropdown {
      position: relative;
      width: 100%;
    }
    .project-dropdown-list {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      margin-top: 4px;
    }
    .project-dropdown-list.show {
      display: block;
    }
    .project-dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .project-dropdown-item:hover {
      background: #374151;
    }
    .project-dropdown-item.selected {
      background: #1e3a5f;
    }
    .project-chip {
      background: #374151;
      color: #e5e7eb;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .project-chip .remove {
      cursor: pointer;
      opacity: 0.7;
    }
    .project-chip .remove:hover {
      opacity: 1;
    }
    .chip {
      background: #111827;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .login-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .login-overlay.active { display: flex; }
    .login-card {
      width: 360px;
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 22px;
      color: #e5e7eb;
      box-shadow: 0 16px 48px rgba(0,0,0,0.45);
    }
    
    /* Add form modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #111;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
    }
    .modal h3 {
      font-size: 18px;
      color: #fff;
      margin-bottom: 20px;
    }
    .modal input, .modal textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      font-family: inherit;
      font-size: 14px;
    }
    .modal input:focus, .modal textarea:focus {
      outline: none;
      border-color: #5b5eef;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    .modal-btn.primary {
      background: #5b5eef;
      color: #fff;
    }
    .modal-btn.primary:hover { background: #4b4edf; }
    .modal-btn.secondary {
      background: transparent;
      color: #999;
    }
    .modal-btn.secondary:hover {
      background: #1a1a1a;
      color: #fff;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #999;
      font-size: 14px;
      margin-bottom: 16px;
      cursor: pointer;
    }
    .checkbox-label input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .settings-modal {
      max-width: 420px;
    }
    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #222;
    }
    .settings-row:last-child {
      border-bottom: none;
    }
    .settings-row label {
      color: #ddd;
      font-size: 14px;
    }
    .settings-row input[type="checkbox"] {
      transform: scale(1.1);
    }
    
    /* Task detail panel - Asana style 2/3 width */
    #taskDetailOverlay {
      justify-content: flex-end;
      overflow: hidden;
    }
    #taskDetailOverlay .task-detail {
      max-width: none;
      width: 66%;
      height: 100vh;
      max-height: 100vh;
      margin: 0;
      border-radius: 0;
      border-left: 1px solid #333;
      display: flex;
      flex-direction: column;
      animation: slideIn 0.2s ease-out;
      padding: 0;
      overflow: hidden;
    }
    .task-detail-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
      padding-top: 0;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    .task-detail-header {
      display: block;
      padding: 24px 32px;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
    }
    .close-btn {
      background: transparent;
      border: none;
      color: #666;
      font-size: 32px;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      margin: -8px -8px 0 0;
    }
    .close-btn:hover {
      color: #fff;
    }
    .task-detail h3 {
      font-size: 24px;
      margin-bottom: 8px;
      color: #fff;
    }
    .detail-title-input {
      width: 100%;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      padding: 0;
      font-family: inherit;
    }
    .detail-title-input:focus {
      outline: none;
      border-bottom: 1px solid #333;
    }
    .task-detail-meta {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }
    .task-detail-meta .meta-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 140px;
    }
    .meta-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
    }
    .meta-select {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      padding: 6px 10px;
      font-family: inherit;
    }
    .meta-select:focus {
      outline: none;
      border-color: #5b5eef;
    }
    .meta-input {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      padding: 6px 10px;
      font-family: inherit;
    }
    .meta-input:focus {
      outline: none;
      border-color: #5b5eef;
    }
    .task-detail-desc {
      background: #1a1a1a;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      color: #ccc;
      font-size: 15px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .detail-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .detail-tab {
      background: transparent;
      border: 1px solid #222;
      color: #777;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .detail-tab.active {
      background: #5b5eef;
      border-color: #5b5eef;
      color: #fff;
    }
    .detail-tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
    }
    .detail-tab-content.active {
      display: flex;
    }
    .activity-log {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    .activity-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }
    .activity-log h4 {
      font-size: 13px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    .activity-view-toggle {
      display: flex;
      gap: 6px;
    }
    .activity-view {
      background: transparent;
      border: 1px solid #222;
      color: #777;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .activity-view.active {
      background: #1f2937;
      border-color: #374151;
      color: #fff;
    }
    .activity-log-item {
      background: #1a1a1a;
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .add-note-section {
      border-top: 1px solid #222;
      padding-top: 24px;
      margin-top: auto;
    }
    .add-note-section h4 {
      font-size: 15px;
      color: #fff;
      margin-bottom: 14px;
    }
    .note-input-group {
      display: flex;
      gap: 12px;
    }
    .note-input-group input {
      flex: 1;
      margin: 0;
      padding: 14px;
      font-size: 15px;
    }
    .comments-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    .comment-item {
      background: #141414;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 12px 14px;
    }
    .comment-meta {
      font-size: 11px;
      color: #777;
      margin-bottom: 6px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .comment-body {
      font-size: 14px;
      color: #ddd;
      line-height: 1.5;
    }
    .comment-actions {
      margin-top: 8px;
      font-size: 11px;
      color: #888;
      cursor: pointer;
    }
    .comment-reply {
      margin-top: 10px;
      display: none;
      gap: 8px;
    }
    .comment-reply.active {
      display: flex;
    }
    .comment-reply input {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
      padding: 8px 10px;
      font-size: 13px;
      font-family: inherit;
    }
    .comment-reply button {
      padding: 8px 12px;
      font-size: 12px;
    }
    
    /* ========== MOBILE RESPONSIVE ========== */
    
    /* Tablet and below */
    @media (max-width: 1024px) {
      .board {
        grid-template-columns: repeat(3, minmax(260px, 1fr));
      }
      .board.show-archive {
        grid-template-columns: repeat(3, minmax(260px, 1fr));
      }
      .columns-header {
        grid-template-columns: repeat(3, minmax(260px, 1fr));
      }
      .columns-header.show-archive {
        grid-template-columns: repeat(3, minmax(260px, 1fr));
      }
      .agents-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Mobile landscape / small tablet */
    @media (max-width: 768px) {
      /* Header */
      .header {
        padding: 16px;
        flex-wrap: wrap;
        gap: 12px;
      }
      .header h1 {
        font-size: 18px;
      }
      .header-subtitle {
        display: none;
      }
      .header-right {
        width: 100%;
        justify-content: flex-end;
        margin-left: 0;
      }
      .search-input {
        width: 150px;
      }
      .search-results {
        width: 280px;
        right: 0;
      }
      
      /* Filters */
      .filters {
        padding: 12px 16px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      .filters::-webkit-scrollbar {
        display: none;
      }
      .board-tabs {
        flex-shrink: 0;
      }
      .board-tab {
        padding: 6px 12px;
        font-size: 12px;
        white-space: nowrap;
      }
      .filter-btn {
        padding: 6px 12px;
        font-size: 12px;
        white-space: nowrap;
      }
      .recurring-filter {
        display: none;
      }
      
      /* Board - horizontal scroll */
      .board {
        grid-template-columns: repeat(5, 280px);
        padding: 10px 16px 20px;
        gap: 12px;
        -webkit-overflow-scrolling: touch;
      }
      .board.show-archive {
        grid-template-columns: repeat(6, 280px);
      }
      .columns-header {
        grid-template-columns: repeat(5, 280px);
        padding: 16px 16px 8px;
        gap: 12px;
      }
      .columns-header.show-archive {
        grid-template-columns: repeat(6, 280px);
      }
      
      /* Cards */
      .card {
        padding: 12px;
      }
      .card-title {
        font-size: 13px;
      }
      
      /* Agents */
      .agents-board {
        padding: 16px;
      }
      .agents-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .agent-lane {
        min-height: 300px;
      }
      
      /* Strategic board */
      .strategic-board {
        grid-template-columns: 1fr;
        padding: 16px;
      }
      
      /* Modal */
      .modal-content {
        width: 95%;
        max-width: none;
        margin: 10px;
        max-height: 90vh;
      }
      .modal-body {
        padding: 16px;
      }
      .modal-header {
        padding: 16px;
      }
      .modal-header h3 {
        font-size: 16px;
      }
    }
    
    /* Mobile portrait */
    @media (max-width: 480px) {
      /* Header */
      .header {
        padding: 12px;
      }
      .header-icon {
        font-size: 20px;
      }
      .header h1 {
        font-size: 16px;
      }
      .header-right {
        gap: 8px;
      }
      .header-gear, .search-icon {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
      .search-input {
        width: 120px;
        padding: 6px 10px;
        font-size: 13px;
      }
      
      /* Filters */
      .filters {
        padding: 10px 12px;
        gap: 8px;
      }
      .board-tab {
        padding: 5px 10px;
        font-size: 11px;
      }
      .filter-btn {
        padding: 5px 10px;
        font-size: 11px;
      }
      
      /* Board - single column option on very small screens */
      .board {
        grid-template-columns: repeat(5, 260px);
        padding: 8px 12px 16px;
        gap: 10px;
      }
      .board.show-archive {
        grid-template-columns: repeat(6, 260px);
      }
      .columns-header {
        grid-template-columns: repeat(5, 260px);
        padding: 12px 12px 6px;
        gap: 10px;
      }
      .columns-header.show-archive {
        grid-template-columns: repeat(6, 260px);
      }
      .column-header {
        font-size: 12px;
      }
      .column-count {
        font-size: 11px;
        padding: 2px 6px;
      }
      
      /* Cards */
      .card {
        padding: 10px;
      }
      .card-title {
        font-size: 12px;
      }
      .card-meta {
        font-size: 10px;
      }
      .card-assignee {
        font-size: 16px;
      }
      .priority-dot {
        width: 6px;
        height: 6px;
      }
      
      /* Add task */
      .add-card-btn {
        padding: 8px;
        font-size: 12px;
      }
      
      /* Modal - full screen on mobile */
      .modal-content {
        width: 100%;
        height: 100%;
        max-height: 100vh;
        margin: 0;
        border-radius: 0;
      }
      .modal-body {
        padding: 12px;
      }
      .modal-header {
        padding: 12px;
        border-radius: 0;
      }
      .modal-header h3 {
        font-size: 15px;
      }
      .modal-close {
        font-size: 20px;
      }
      
      /* Form elements */
      .modal-body input,
      .modal-body select,
      .modal-body textarea {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 12px;
      }
      .modal-body label {
        font-size: 12px;
      }
      
      /* Activity log */
      .activity-log-item {
        padding: 10px 12px;
        font-size: 13px;
        gap: 8px;
      }
      
      /* Comments */
      .comment-item {
        padding: 10px 12px;
      }
      .comment-body {
        font-size: 13px;
      }
      
      /* Note input */
      .note-input-group {
        flex-direction: column;
      }
      .note-input-group input {
        padding: 12px;
        font-size: 16px;
      }
      .note-input-group button {
        padding: 12px;
      }
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .card {
        cursor: default;
      }
      .card:active {
        transform: scale(0.98);
      }
      .filter-btn:active,
      .board-tab:active {
        transform: scale(0.95);
      }
      /* Larger touch targets */
      .card-actions button {
        min-width: 44px;
        min-height: 44px;
      }
      .modal-close {
        min-width: 44px;
        min-height: 44px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <div class="header-icon">‚ö°</div>
      <div>
        <h1>Mission Control</h1>
        <div class="header-subtitle">HiM's Enterprise Crew</div>
      </div>
    </div>
    <div class="header-right">
      <div class="board-tabs">
        <button class="board-tab active" data-board="ops" onclick="setBoard('ops')">Ops</button>
        <button class="board-tab" data-board="strategic" onclick="setBoard('strategic')">Strategic</button>
        <button class="board-tab" data-board="agents" onclick="setBoard('agents')">Agents</button>
      </div>
      <div class="search-container">
        <button class="search-icon" onclick="toggleSearch()" aria-label="Search">üîç</button>
        <input type="text" class="search-input" id="globalSearchInput" placeholder="Search tasks..." onkeyup="handleSearchKeyup(event)" style="display:none;">
        <button class="search-clear" id="searchClear" onclick="clearSearch()" style="display:none;">‚úï</button>
        <div class="search-results" id="searchResults" style="display:none;"></div>
      </div>
      <button class="header-gear" onclick="toggleSettings()" aria-label="Settings">‚öôÔ∏è</button>
    </div>
  </div>

  <div class="summary-bar" id="summaryBar">
    <div class="pill" id="summaryAssigned">üë§ Assigned: 0</div>
    <div class="pill" id="summaryDueToday">üìÖ Due today: 0</div>
    <div class="pill" id="summaryOverdue">‚è∞ Overdue: 0</div>
    <div class="pill" id="summaryCapacity">üß† Capacity check</div>
  </div>

  <div class="filters">
    <button class="filter-btn" onclick="toggleModal()">+ New task</button>
    <button class="filter-btn secondary" data-filter="Ada" onclick="filterByUser('Ada')">Ada</button>
    <button class="filter-btn secondary" data-filter="Spock" onclick="filterByUser('Spock')">Spock</button>
    <button class="filter-btn secondary" data-filter="Scotty" onclick="filterByUser('Scotty')">Scotty</button>
    <button class="filter-btn secondary" data-filter="Henry" onclick="filterByUser('Henry')">Henry</button>
    <button class="filter-btn secondary active" data-filter="all" onclick="filterByUser('all')">All</button>
    <select id="priorityFilter" class="filter-btn secondary" onchange="setPriorityFilter(this.value)" style="width: 140px; text-align: left;">
      <option value="all">Priority: All</option>
      <option value="P0">Priority: P0</option>
      <option value="P1">Priority: P1</option>
      <option value="P2">Priority: P2</option>
      <option value="P3">Priority: P3</option>
    </select>
    <select id="projectFilter" class="filter-btn secondary" onchange="setProjectFilter(this.value)" style="min-width: 150px; text-align: left;">
      <option value="all">Projects: All</option>
    </select>
    <button class="filter-btn secondary" id="dueTodayBtn" onclick="toggleDueToday()">Due today</button>
    <button class="filter-btn secondary" id="dailyViewBtn" onclick="toggleDailyView()">Daily view</button>
    <div class="recurring-filter" onclick="toggleRecurring()">
      <div class="recurring-dot"></div>
      <span>Recurring</span>
      <span class="recurring-count" id="recurringCount">0</span>
    </div>
  </div>

  <div style="padding: 10px 30px 0;">
    <div style="display: flex; justify-content: flex-end; margin-bottom: 8px;">
      <button class="filter-btn secondary" id="insightsToggle" onclick="toggleInsights()" style="font-size: 12px; padding: 4px 10px;">
        <span id="insightsToggleIcon">‚ñº</span> Insights
      </button>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; transition: all 0.3s ease; overflow: hidden;" id="insightsRow">
      <div class="panel" id="dueTodayPanel">
        <h4>Due today</h4>
        <div id="dueTodayList" style="font-size: 13px; color: #9ca3af;">No tasks due today.</div>
      </div>
      <div class="panel" id="activityPanel">
        <h4>Live activity</h4>
        <div id="recentActivityList" style="font-size: 13px; color: #9ca3af;">Waiting for updates...</div>
      </div>
      <div class="panel" id="metricsPanel">
        <h4>Metrics</h4>
        <div id="metricsList" style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; font-size: 13px; color: #e5e7eb;"></div>
      </div>
    </div>
  </div>

  <div style="padding: 0 30px; margin-bottom: 8px;">
    <button class="filter-btn secondary" id="kanbanToggle" onclick="toggleKanban()" style="font-size: 12px; padding: 4px 10px;">
      <span id="kanbanToggleIcon">‚ñº</span> Kanban
    </button>
  </div>
  <div id="kanbanWrapper" style="transition: all 0.3s ease; overflow: hidden;">
  <div class="columns-header" id="columnsHeader">
    <div class="column-header">
      <span>Backlog</span>
      <span class="column-count" id="count-backlog">0</span>
    </div>
    <div class="column-header">
      <span>Todo</span>
      <span class="column-count" id="count-todo">0</span>
    </div>
    <div class="column-header">
      <span>Doing</span>
      <span class="column-count" id="count-doing">0</span>
    </div>
    <div class="column-header">
      <span>Review</span>
      <span class="column-count" id="count-review">0</span>
    </div>
    <div class="column-header">
      <span>Done</span>
      <span class="column-count" id="count-done">0</span>
    </div>
    <div class="column-header archive-column">
      <span>Archive</span>
      <span class="column-count" id="count-archive">0</span>
    </div>
  </div>

  <div class="board" id="board">
    <div class="column" data-column="backlog">
      <div class="tasks"></div>
    </div>
    <div class="column" data-column="todo">
      <div class="tasks"></div>
    </div>
    <div class="column" data-column="doing">
      <div class="tasks"></div>
    </div>
    <div class="column" data-column="review">
      <div class="tasks"></div>
    </div>
    <div class="column" data-column="done">
      <div class="tasks"></div>
    </div>
    <div class="column archive-column" data-column="archive">
      <div class="tasks"></div>
    </div>
  </div>
  </div><!-- end kanbanWrapper -->

  <div class="strategic-board" id="strategicBoard">
    <div class="strategic-panel">
      <h4>Roadmaps</h4>
      <div id="roadmapsList" class="strategic-empty">Roadmaps will live here.</div>
      <div style="display: flex; gap: 8px; margin-top: 10px;">
        <input type="text" id="roadmapNameInput" class="meta-input" placeholder="New roadmap name" />
        <button class="filter-btn secondary" onclick="createRoadmap()">Create</button>
      </div>
    </div>
    <div class="strategic-panel">
      <h4>Recurring Tasks</h4>
      <div id="strategicRecurring"></div>
    </div>
  </div>

  <!-- Agents Dashboard -->
  <div class="agents-board" id="agentsBoard" style="display: none;">
    <div class="agents-header">
      <h3>Agent Activity Dashboard</h3>
      <button class="filter-btn secondary" onclick="refreshAgentActivity()">üîÑ Refresh</button>
    </div>
    <div class="agents-grid">
      <div class="agent-lane" data-agent="Ada">
        <div class="agent-lane-header">
          <span class="agent-avatar">üîÆ</span>
          <span class="agent-name">Ada</span>
          <span class="agent-status" id="ada-status">Checking...</span>
        </div>
        <div class="agent-current-task" id="ada-task">No active task</div>
        <div class="agent-activity-log" id="ada-log">Loading...</div>
      </div>
      <div class="agent-lane" data-agent="Spock">
        <div class="agent-lane-header">
          <span class="agent-avatar">üññ</span>
          <span class="agent-name">Spock</span>
          <span class="agent-status" id="spock-status">Checking...</span>
        </div>
        <div class="agent-current-task" id="spock-task">No active task</div>
        <div class="agent-activity-log" id="spock-log">Loading...</div>
      </div>
      <div class="agent-lane" data-agent="Scotty">
        <div class="agent-lane-header">
          <span class="agent-avatar">üîß</span>
          <span class="agent-name">Scotty</span>
          <span class="agent-status" id="scotty-status">Checking...</span>
        </div>
        <div class="agent-current-task" id="scotty-task">No active task</div>
        <div class="agent-activity-log" id="scotty-log">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3>New Task</h3>
      <input type="text" id="taskName" placeholder="Task name" required />
      <textarea id="taskDesc" placeholder="Description (optional)" rows="3"></textarea>
      <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px;">
        <div>
          <label class="meta-label">Assignee</label>
          <select id="taskAssignee" class="meta-select" style="width: 100%; margin-top: 6px;">
            <option value="Unassigned">Unassigned</option>
            <option value="Ada">Ada</option>
            <option value="Spock">Spock</option>
            <option value="Scotty">Scotty</option>
            <option value="Henry">Henry</option>
          </select>
        </div>
        <div>
          <label class="meta-label">Due Date</label>
          <input type="date" id="taskDueDate" class="meta-input" style="width: 100%; margin-top: 6px;" required />
        </div>
        <div>
          <label class="meta-label">Priority</label>
          <select id="taskPriority" class="meta-select" style="width: 100%; margin-top: 6px;">
            <option value="P0">P0</option>
            <option value="P1">P1</option>
            <option value="P2" selected>P2</option>
            <option value="P3">P3</option>
          </select>
        </div>
        <div>
          <label class="meta-label">Column</label>
          <select id="taskColumn" class="meta-select" style="width: 100%; margin-top: 6px;">
            <option value="backlog">Backlog</option>
            <option value="todo">Todo</option>
            <option value="doing">Doing</option>
            <option value="review">Review</option>
          </select>
        </div>
        <div>
          <label class="meta-label">Model (Override)</label>
          <select id="taskModel" class="meta-select" style="width: 100%; margin-top: 6px;">
            <option value="">Default (Agent's Choice)</option>
            <!-- Models populated by JS -->
          </select>
        </div>
      </div>
      <div style="margin: 10px 0;">
        <label class="meta-label">Projects</label>
        <div id="taskProjects" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px;"></div>
      </div>
      <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px;">
        <label class="checkbox-label" style="margin: 0;">
          <input type="checkbox" id="taskRecurring" />
          <span>Recurring task</span>
        </label>
        <div>
          <label class="meta-label">Estimate (hrs)</label>
          <input type="number" step="0.25" id="taskEstimate" class="meta-input" style="width: 100%; margin-top: 6px;" placeholder="optional" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" onclick="toggleModal()">Cancel</button>
        <button class="modal-btn primary" onclick="addTask()">Add Task</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsOverlay">
    <div class="modal settings-modal">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
        <h3 style="margin: 0;">Settings</h3>
        <button class="close-btn" onclick="toggleSettings()">√ó</button>
      </div>
      <div class="settings-row">
        <label for="settingsArchiveToggle">Show Archive column</label>
        <input type="checkbox" id="settingsArchiveToggle" />
      </div>
    </div>
  </div>

  <!-- Task Detail Panel - Asana style -->
  <div class="modal-overlay" id="taskDetailOverlay">
    <div class="modal task-detail">
      <div class="task-detail-header">
        <!-- Top bar: Title + Actions -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
          <input id="detailTaskName" class="detail-title-input" type="text" style="flex: 1; margin-right: 16px;" />
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="filter-btn secondary" onclick="triggerContinue()">Continue work</button>
            <button class="filter-btn" onclick="createFollowUp()">Follow-up</button>
            <button class="close-btn" onclick="closeTaskDetail()" style="margin-left: 8px;">√ó</button>
          </div>
        </div>
        
        <!-- Row 1: Core fields (5 columns) -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 16px;">
          <div>
            <span class="meta-label">Assignee</span>
            <select id="detailAssignee" class="meta-select" style="width: 100%; margin-top: 4px;">
              <option value="Ada">Ada</option>
              <option value="Spock">Spock</option>
              <option value="Scotty">Scotty</option>
              <option value="Henry">Henry</option>
              <option value="Unassigned">Unassigned</option>
            </select>
          </div>
          <div>
            <span class="meta-label">Due date</span>
            <input type="date" id="detailDueDate" class="meta-input" style="width: 100%; margin-top: 4px;" />
          </div>
          <div>
            <span class="meta-label">Priority</span>
            <select id="detailPriority" class="meta-select" style="width: 100%; margin-top: 4px;">
              <option value="P0">P0</option>
              <option value="P1">P1</option>
              <option value="P2">P2</option>
              <option value="P3">P3</option>
            </select>
          </div>
          <div>
            <span class="meta-label">Column</span>
            <select id="detailColumn" class="meta-select" style="width: 100%; margin-top: 4px;">
              <option value="backlog">Backlog</option>
              <option value="todo">Todo</option>
              <option value="doing">Doing</option>
              <option value="review">Review</option>
              <option value="done">Done</option>
            </select>
          </div>
          <div>
            <span class="meta-label">Model</span>
            <select id="detailModel" class="meta-select" style="width: 100%; margin-top: 4px;">
              <option value="">Default</option>
              <!-- Models populated by JS -->
            </select>
          </div>
        </div>

        <!-- Row 2: Time tracking + Blocked (3 columns) -->
        <div style="display: grid; grid-template-columns: 100px 100px 1fr; gap: 16px; margin-bottom: 16px;">
          <div>
            <span class="meta-label">Estimate</span>
            <input type="number" step="0.25" id="detailEstimate" class="meta-input" style="width: 100%; margin-top: 4px;" placeholder="hrs" />
          </div>
          <div>
            <span class="meta-label">Time spent</span>
            <input type="number" step="0.25" id="detailTimeSpent" class="meta-input" style="width: 100%; margin-top: 4px;" placeholder="hrs" />
          </div>
          <div>
            <span class="meta-label">Blocked?</span>
            <div style="display: flex; gap: 8px; align-items: center; margin-top: 4px;">
              <label class="checkbox-label" style="margin: 0;">
                <input type="checkbox" id="detailBlocked" />
                <span>Yes</span>
              </label>
              <input type="text" id="detailBlockerReason" class="meta-input" style="flex: 1;" placeholder="Reason..." />
            </div>
          </div>
        </div>

        <!-- Row 3: Metadata (subtle) -->
        <div style="display: flex; gap: 24px; font-size: 12px; color: #6b7280;">
          <span id="detailCreatedBy"></span>
          <span id="detailCreatedAt"></span>
          <span id="detailUpdatedAt"></span>
        </div>
      </div>
      
      <div class="task-detail-scroll">
      <div class="task-detail-desc" id="detailDesc" style="display: none;"></div>
      
      <!-- Projects & Dependencies (2 columns) -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px;">
        <div>
          <div class="meta-label" style="margin-bottom: 8px;">Projects</div>
          <div id="detailProjects" style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;"></div>
          <div class="project-dropdown" id="projectDropdown">
            <input type="text" class="meta-input" id="projectSearchInput" placeholder="Search projects..." onclick="toggleProjectDropdown()" oninput="filterProjects()" />
            <div class="project-dropdown-list" id="projectDropdownList"></div>
          </div>
        </div>
        <div>
          <div class="meta-label" style="margin-bottom: 8px;">Dependencies</div>
          <div id="detailDependencies" style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;"></div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" id="detailDependenciesInput" class="meta-input" placeholder="Task IDs (e.g. 1, 2, 3)" style="width: 180px;" />
            <button class="filter-btn secondary" style="padding: 6px 12px; font-size: 12px;" onclick="saveDependencies()">Save</button>
          </div>
        </div>
      </div>
      
      <!-- Attachments -->
      <div style="margin-bottom: 20px;">
        <div class="meta-label" style="margin-bottom: 8px;">Attachments</div>
        <div id="detailAttachments" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px;"></div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <input type="text" id="attachmentName" class="meta-input" placeholder="Name" style="width: 120px;" />
          <input type="text" id="attachmentPath" class="meta-input" placeholder="URL or path" style="flex: 1; max-width: 250px;" />
          <button class="filter-btn secondary" style="padding: 6px 12px; font-size: 12px;" onclick="addAttachment()">Attach</button>
        </div>
      </div>

      <div class="detail-tabs">
        <button class="detail-tab active" data-tab="activity" onclick="setDetailTab('activity')">Activity</button>
        <button class="detail-tab" data-tab="comments" onclick="setDetailTab('comments')">Comments</button>
      </div>

      <div class="detail-tab-content active" id="detailActivityTab">
        <div class="activity-log">
          <div class="activity-header">
            <h4>Activity Log</h4>
            <div style="display: flex; gap: 12px; align-items: center;">
              <button class="filter-btn secondary" style="padding: 4px 8px; font-size: 11px;" onclick="syncSessionLogs()">üîÑ Sync</button>
              <div class="activity-view-toggle">
                <button class="activity-view active" data-view="human" onclick="setActivityView('human')">Human</button>
                <button class="activity-view" data-view="technical" onclick="setActivityView('technical')">Technical</button>
              </div>
            </div>
          </div>
          <div id="detailActivityLog"></div>
        </div>
        
        <div class="add-note-section">
          <h4>Add Note</h4>
          <div class="note-input-group">
            <input type="text" id="noteInput" placeholder="Add a note or update..." />
            <button class="modal-btn primary" onclick="addNote()">Add</button>
          </div>
        </div>
      </div>

      <div class="detail-tab-content" id="detailCommentsTab">
        <div class="comments-list" id="detailCommentsList"></div>
        <div class="note-input-group">
          <input type="text" id="commentInput" placeholder="Add a comment..." />
          <button class="modal-btn primary" onclick="addComment()">Comment</button>
        </div>
      </div>
      </div><!-- end task-detail-scroll -->
    </div>
  </div>

  <div class="login-overlay" id="loginOverlay">
    <div class="login-card">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
        <h3 style="margin: 0;">Login</h3>
        <button class="close-btn" onclick="hideLogin()">√ó</button>
      </div>
      <p style="font-size: 13px; color: #9ca3af; margin-bottom: 12px;">Enter your Mission Control credentials (default password: mission).</p>
      <input type="text" id="loginUsername" placeholder="Username" class="meta-input" />
      <input type="password" id="loginPassword" placeholder="Password" class="meta-input" />
      <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
        <button class="filter-btn" style="flex: 1;" onclick="attemptLogin()">Login</button>
        <!-- API key login hidden - for agent/programmatic access only -->
      </div>
      <div id="loginError" style="color: #f87171; margin-top: 8px; font-size: 13px;"></div>
    </div>
  </div>

  <script>
    let draggedTask = null;
    let currentFilter = 'all';
    let currentPriorityFilter = 'all';
    let currentProjectFilter = 'all';
    let showRecurringOnly = false;
    let showDueTodayOnly = false;
    let dailyView = false;
    let allTasks = [];
    let projects = [];
    let roadmaps = [];
    let recentActivity = [];
    let currentTaskId = null;
    let currentBoard = 'ops';
    let currentDetailTab = 'activity';
    let currentActivityView = 'human';
    let currentUser = null;
    let authEnabled = true;
    const sessionId = (() => {
      let id = localStorage.getItem('mc_session_id');
      if (!id) {
        id = `mc_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
        localStorage.setItem('mc_session_id', id);
      }
      return id;
    })();
    const capacityLimits = { Scotty: 3 };
    let showArchive = false;
    let searchDebounce = null;

    // Global Search Functions
    function toggleSearch() {
      const input = document.getElementById('globalSearchInput');
      const clear = document.getElementById('searchClear');
      const results = document.getElementById('searchResults');
      
      if (input.style.display === 'none') {
        input.style.display = 'block';
        clear.style.display = 'block';
        input.focus();
      } else {
        input.style.display = 'none';
        clear.style.display = 'none';
        results.style.display = 'none';
        input.value = '';
      }
    }

    function clearSearch() {
      const input = document.getElementById('globalSearchInput');
      const results = document.getElementById('searchResults');
      input.value = '';
      results.style.display = 'none';
      input.focus();
    }

    function handleSearchKeyup(e) {
      if (e.key === 'Escape') {
        toggleSearch();
        return;
      }
      
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => doSearch(), 300);
    }

    async function doSearch() {
      const q = document.getElementById('globalSearchInput').value.trim();
      const results = document.getElementById('searchResults');
      
      if (!q) {
        results.style.display = 'none';
        return;
      }
      
      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(q)}&limit=10`);
        const data = await res.json();
        
        if (data.results.length === 0) {
          results.innerHTML = '<div class="search-no-results">No results found</div>';
        } else {
          results.innerHTML = data.results.map(r => `
            <div class="search-result" onclick="openTaskFromSearch(${r.task_id})">
              <div class="search-result-title">${escapeHtml(r.task_name)}</div>
              <div class="search-result-snippet">${r.snippet}</div>
            </div>
          `).join('');
        }
        results.style.display = 'block';
      } catch (err) {
        console.error('Search failed:', err);
      }
    }

    function openTaskFromSearch(taskId) {
      document.getElementById('globalSearchInput').style.display = 'none';
      document.getElementById('searchClear').style.display = 'none';
      document.getElementById('searchResults').style.display = 'none';
      openTaskDetail(taskId);
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Keyboard shortcut for search
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        toggleSearch();
      }
    });

    function showLogin(message = '') {
      const overlay = document.getElementById('loginOverlay');
      const errorEl = document.getElementById('loginError');
      if (errorEl) errorEl.textContent = message;
      overlay.classList.add('active');
    }

    function hideLogin() {
      document.getElementById('loginOverlay').classList.remove('active');
    }

    async function apiFetch(url, options = {}) {
      const opts = { credentials: 'include', ...options };
      opts.headers = {
        'Content-Type': 'application/json',
        ...(options.headers || {}),
      };
      const res = await fetch(url, opts);
      if (res.status === 401) {
        showLogin('Session expired. Please log in.');
        throw new Error('Unauthorized');
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || 'Request failed');
      }
      return res.json();
    }

    async function checkSession() {
      try {
        const res = await fetch('/api/auth/session', { credentials: 'include' });
        if (res.status === 401) {
          showLogin();
          return false;
        }
        const data = await res.json();
        currentUser = data.user;
        authEnabled = data.authEnabled;
        return true;
      } catch (e) {
        showLogin('Unable to verify session');
        return false;
      }
    }

    async function attemptLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const errorEl = document.getElementById('loginError');
      errorEl.textContent = '';
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password }),
        });
        if (!res.ok) {
          errorEl.textContent = 'Invalid credentials';
          return;
        }
        const data = await res.json();
        currentUser = data.user;
        hideLogin();
        boot();
      } catch (err) {
        errorEl.textContent = 'Login failed';
      }
    }

    async function loginWithApiKey() {
      const apiKey = prompt('Enter API key');
      if (!apiKey) return;
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ apiKey }),
        });
        if (!res.ok) {
          document.getElementById('loginError').textContent = 'Invalid API key';
          return;
        }
        const data = await res.json();
        currentUser = data.user;
        hideLogin();
        boot();
      } catch {
        document.getElementById('loginError').textContent = 'Login failed';
      }
    }

    function setArchiveVisibility(value) {
      showArchive = value;
      localStorage.setItem('mc_showArchive', showArchive ? 'true' : 'false');
      document.getElementById('board').classList.toggle('show-archive', showArchive);
      document.getElementById('columnsHeader').classList.toggle('show-archive', showArchive);
      const toggleEl = document.getElementById('settingsArchiveToggle');
      if (toggleEl) toggleEl.checked = showArchive;
    }

    function toggleSettings() {
      const overlay = document.getElementById('settingsOverlay');
      overlay.classList.toggle('active');
    }

    async function loadProjects() {
      try {
        projects = await apiFetch('/api/projects');
        const projectFilter = document.getElementById('projectFilter');
        projectFilter.innerHTML = '<option value="all">Projects: All</option>';
        projects.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          projectFilter.appendChild(opt);
        });

        const projectsContainer = document.getElementById('taskProjects');
        projectsContainer.innerHTML = '';
        projects.forEach(p => {
          const label = document.createElement('label');
          label.className = 'checkbox-label';
          label.style.margin = '0';
          label.innerHTML = `<input type="checkbox" value="${p.id}" /> <span>${p.name}</span>`;
          projectsContainer.appendChild(label);
        });
      } catch (err) {
        console.error('Failed to load projects', err);
      }
    }

    async function loadRoadmaps() {
      try {
        roadmaps = await apiFetch('/api/roadmaps');
      } catch (err) {
        console.error('Failed to load roadmaps', err);
      }
    }

    async function loadRecentActivity() {
      try {
        recentActivity = await apiFetch('/api/activity/recent?limit=25');
        renderActivityPanel();
      } catch (err) {
        console.error('Failed to load activity', err);
      }
    }

    async function loadTasks() {
      try {
        allTasks = await apiFetch('/api/tasks');
        renderTasks();
        renderDueToday();
        renderMetrics();
        renderSummary();
        renderStrategic();
      } catch (err) {
        console.error('Failed to load tasks', err);
      }
    }

    function filterByUser(user) {
      currentFilter = user;
      document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === user) btn.classList.add('active');
      });
      renderTasks();
    }

    function setPriorityFilter(priority) {
      currentPriorityFilter = priority;
      renderTasks();
    }

    function setProjectFilter(projectId) {
      currentProjectFilter = projectId;
      renderTasks();
    }

    function toggleInsights() {
      const row = document.getElementById('insightsRow');
      const icon = document.getElementById('insightsToggleIcon');
      const isCollapsed = row.style.maxHeight === '0px';
      
      if (isCollapsed) {
        row.style.maxHeight = '500px';
        row.style.opacity = '1';
        row.style.marginBottom = '0';
        icon.textContent = '‚ñº';
        localStorage.setItem('mc_insightsCollapsed', 'false');
      } else {
        row.style.maxHeight = '0px';
        row.style.opacity = '0';
        row.style.marginBottom = '-12px';
        icon.textContent = '‚ñ∂';
        localStorage.setItem('mc_insightsCollapsed', 'true');
      }
    }

    function initInsights() {
      const collapsed = localStorage.getItem('mc_insightsCollapsed') === 'true';
      if (collapsed) {
        const row = document.getElementById('insightsRow');
        const icon = document.getElementById('insightsToggleIcon');
        row.style.maxHeight = '0px';
        row.style.opacity = '0';
        row.style.marginBottom = '-12px';
        icon.textContent = '‚ñ∂';
      }
    }

    function toggleKanban() {
      const wrapper = document.getElementById('kanbanWrapper');
      const icon = document.getElementById('kanbanToggleIcon');
      const isCollapsed = wrapper.style.maxHeight === '0px';
      
      if (isCollapsed) {
        wrapper.style.maxHeight = '2000px';
        wrapper.style.opacity = '1';
        icon.textContent = '‚ñº';
        localStorage.setItem('mc_kanbanCollapsed', 'false');
      } else {
        wrapper.style.maxHeight = '0px';
        wrapper.style.opacity = '0';
        icon.textContent = '‚ñ∂';
        localStorage.setItem('mc_kanbanCollapsed', 'true');
      }
    }

    function initKanban() {
      const collapsed = localStorage.getItem('mc_kanbanCollapsed') === 'true';
      if (collapsed) {
        const wrapper = document.getElementById('kanbanWrapper');
        const icon = document.getElementById('kanbanToggleIcon');
        wrapper.style.maxHeight = '0px';
        wrapper.style.opacity = '0';
        icon.textContent = '‚ñ∂';
      }
    }

    function toggleRecurring() {
      if (currentBoard === 'strategic') return;
      showRecurringOnly = !showRecurringOnly;
      renderTasks();
    }

    function toggleDueToday() {
      showDueTodayOnly = !showDueTodayOnly;
      document.getElementById('dueTodayBtn').classList.toggle('active', showDueTodayOnly);
      renderTasks();
    }

    function toggleDailyView() {
      dailyView = !dailyView;
      document.getElementById('dailyViewBtn').classList.toggle('active', dailyView);
      renderTasks();
    }

    function setBoard(board, updateHash = true) {
      currentBoard = board;
      if (updateHash) window.location.hash = board;
      document.querySelectorAll('.board-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.board === board));
      
      const isOps = board === 'ops';
      const isStrategic = board === 'strategic';
      const isAgents = board === 'agents';
      
      document.getElementById('columnsHeader').style.display = isOps ? 'grid' : 'none';
      document.getElementById('board').style.display = isOps ? 'grid' : 'none';
      document.getElementById('strategicBoard').style.display = isStrategic ? 'grid' : 'none';
      document.getElementById('agentsBoard').style.display = isAgents ? 'block' : 'none';
      
      if (isAgents) {
        refreshAgentActivity();
      } else {
        renderTasks();
        renderStrategic();
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function statusClass(column, blocked) {
      if (blocked) return 'status-blocked';
      if (column === 'backlog') return 'status-backlog';
      if (column === 'todo') return 'status-todo';
      if (column === 'doing' || column === 'in-progress') return 'status-doing';
      if (column === 'review') return 'status-review';
      if (column === 'done' || column === 'complete') return 'status-done';
      if (column === 'archive') return 'status-archive';
      return 'status-backlog';
    }

    function renderTasks() {
      document.querySelectorAll('.tasks').forEach(el => el.innerHTML = '');
      let filtered = allTasks;
      if (currentFilter !== 'all') {
        filtered = filtered.filter(t => (t.assignee || 'Unassigned') === currentFilter);
      }
      if (currentPriorityFilter !== 'all') {
        filtered = filtered.filter(t => (t.priority || 'P2') === currentPriorityFilter);
      }
      if (currentProjectFilter !== 'all') {
        filtered = filtered.filter(t => (t.projects || []).some(p => String(p.id) === String(currentProjectFilter)));
      }
      if (currentBoard === 'strategic') {
        filtered = filtered.filter(t => t.recurring || t.roadmap_id);
      } else {
        // Hide recurring tasks from Ops board unless explicitly showing them
        if (showRecurringOnly) {
          filtered = filtered.filter(t => t.recurring);
        } else {
          filtered = filtered.filter(t => !t.recurring);
        }
        if (showDueTodayOnly || dailyView) {
          const today = new Date().toISOString().slice(0, 10);
          filtered = filtered.filter(t => (t.due_date || '').slice(0, 10) <= today && (t.column !== 'done' && t.column !== 'complete'));
        }
        if (!showArchive) {
          filtered = filtered.filter(t => !t.archived && t.column !== 'archive');
        }
      }

      const backlog = filtered.filter(t => t.column === 'backlog').length;
      const todo = filtered.filter(t => t.column === 'todo').length;
      const doing = filtered.filter(t => t.column === 'doing' || t.column === 'in-progress').length;
      const review = filtered.filter(t => t.column === 'review').length;
      const done = filtered.filter(t => t.column === 'done' || t.column === 'complete').length;
      const archive = filtered.filter(t => t.column === 'archive').length;
      const recurring = allTasks.filter(t => t.recurring).length;

      document.getElementById('count-backlog').textContent = backlog;
      document.getElementById('count-todo').textContent = todo;
      document.getElementById('count-doing').textContent = doing;
      document.getElementById('count-review').textContent = review;
      document.getElementById('count-done').textContent = done;
      document.getElementById('count-archive').textContent = archive;
      document.getElementById('recurringCount').textContent = recurring;

      if (currentBoard === 'strategic') {
        const recurringList = document.getElementById('strategicRecurring');
        recurringList.innerHTML = '';
        filtered.filter(t => t.recurring).forEach(task => recurringList.appendChild(createTaskElement(task)));
      } else {
        filtered.forEach(task => {
          let col = task.column;
          if (col === 'in-progress') col = 'doing';
          if (col === 'complete') col = 'done';
          const column = document.querySelector(`[data-column="${col}"] .tasks`);
          if (column) column.appendChild(createTaskElement(task));
        });
      }
    }

    function createTaskElement(task) {
      const div = document.createElement('div');
      div.className = 'task';
      div.draggable = true;
      div.dataset.id = task.id;

      // Add working/blocked classes
      const isWorking = task.progress_status === 'working' || (task.column === 'doing' && !task.blocked && hasRecentTaskActivity(task));
      const isBlocked = task.blocked;
      if (isWorking) div.classList.add('working');
      if (isBlocked) div.classList.add('blocked');

      const dueDate = formatDate(task.due_date);
      const assignee = task.assignee || 'Unassigned';
      const priority = (task.priority || 'P2').toUpperCase();
      const priorityClass = `priority-${priority.toLowerCase()}`;

      // Indicator for working/blocked
      let indicator = '';
      if (isBlocked) {
        indicator = '<div class="blocked-indicator">üö®</div>';
      } else if (isWorking) {
        indicator = '<div class="working-indicator"></div>';
      }

      // Get latest activity for status preview
      const latestActivity = (task.activity || [])[0];
      let statusPreview = '';
      
      if (isBlocked && task.blocker_reason) {
        // Show blocker reason
        statusPreview = `<div class="task-status blocked-status">‚ùå ${task.blocker_reason.slice(0, 80)}${task.blocker_reason.length > 80 ? '...' : ''}</div>`;
      } else if (isWorking && latestActivity) {
        // Show latest activity
        const timeAgo = getTimeAgo(latestActivity.created_at);
        statusPreview = `<div class="task-status working-status">üîß ${latestActivity.user}: ${(latestActivity.details || latestActivity.action).slice(0, 60)}... <span class="time-ago">${timeAgo}</span></div>`;
      }

      div.innerHTML = `
        ${indicator}
        <div class="task-header">
          <span class="status-dot ${statusClass(task.column, task.blocked)}"></span>
          <div class="task-name">${task.name}</div>
          ${task.recurring ? '<div class="recurring-badge"></div>' : ''}
          ${task.blocked ? '<div class="priority-badge priority-p0">Blocked</div>' : ''}
        </div>
        ${task.description ? `<div class="task-desc">${task.description}</div>` : ''}
        ${statusPreview}
        <div class="task-meta">
          <div class="task-meta-left">
            <span class="assignee-pill">${assignee}</span>
            <span class="priority-badge ${priorityClass}">${priority}</span>
          </div>
          <span>${dueDate}</span>
        </div>
      `;

      div.addEventListener('dragstart', () => {
        draggedTask = div;
        div.classList.add('dragging');
      });

      div.addEventListener('dragend', () => {
        div.classList.remove('dragging');
      });

      div.addEventListener('click', () => {
        if (!div.classList.contains('dragging')) openTaskDetail(task.id);
      });

      return div;
    }

    // Check if task has recent activity (within last 10 minutes)
    function hasRecentTaskActivity(task) {
      if (!task.activity || !task.activity.length) return false;
      const latest = task.activity[0];
      const latestTime = new Date(latest.created_at).getTime();
      const tenMinutesAgo = Date.now() - (10 * 60 * 1000);
      return latestTime > tenMinutesAgo;
    }

    // Human-readable time ago
    function getTimeAgo(timestamp) {
      const now = Date.now();
      const then = new Date(timestamp).getTime();
      const diff = Math.floor((now - then) / 1000);
      
      if (diff < 60) return 'just now';
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return `${Math.floor(diff / 86400)}d ago`;
    }

    function renderSummary() {
      const assigneeName = currentUser?.username || 'Ada';
      const assigned = allTasks.filter(t => t.assignee === assigneeName && t.column !== 'done' && t.column !== 'complete');
      const dueToday = assigned.filter(t => (t.due_date || '').slice(0, 10) === new Date().toISOString().slice(0, 10));
      const overdue = assigned.filter(t => (t.due_date || '') < new Date().toISOString().slice(0, 10) && t.column !== 'done' && t.column !== 'complete');
      const capacityLimit = capacityLimits[assigneeName] || null;
      const capacityText = capacityLimit ? `${assigned.filter(t => t.column === 'doing').length}/${capacityLimit} doing` : `${assigned.filter(t => t.column === 'doing').length} doing`;
      document.getElementById('summaryAssigned').textContent = `üë§ Assigned: ${assigned.length}`;
      document.getElementById('summaryDueToday').textContent = `üìÖ Due today: ${dueToday.length}`;
      document.getElementById('summaryOverdue').textContent = `‚è∞ Overdue: ${overdue.length}`;
      document.getElementById('summaryCapacity').textContent = `üß† Capacity: ${capacityText}`;
    }

    function renderDueToday() {
      const today = new Date().toISOString().slice(0, 10);
      const dueToday = allTasks.filter(t => (t.due_date || '').slice(0, 10) === today && t.column !== 'done' && t.column !== 'complete');
      const overdue = allTasks.filter(t => (t.due_date || '') < today && t.column !== 'done' && t.column !== 'complete');
      const list = document.getElementById('dueTodayList');
      if (!dueToday.length && !overdue.length) {
        list.textContent = 'No tasks due today.';
        return;
      }
      const items = [...overdue, ...dueToday].slice(0, 6).map(t => `<div style="display:flex; justify-content:space-between; margin-bottom:6px;"><span>${t.name}</span><span style="color:${(t.due_date || '') < today ? '#f87171' : '#9ca3af'}">${formatDate(t.due_date)}</span></div>`).join('');
      list.innerHTML = items;
    }

    function renderActivityPanel() {
      const container = document.getElementById('recentActivityList');
      container.innerHTML = '';
      if (!recentActivity.length) {
        container.textContent = 'Waiting for updates...';
        return;
      }
      recentActivity.slice(0, 10).forEach(act => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.fontSize = '13px';
        row.style.marginBottom = '6px';
        row.innerHTML = `<span><strong>${act.user}</strong> ${act.action} ${act.details || ''}</span><span style="color:#6b7280;">${new Date(act.created_at).toLocaleTimeString()}</span>`;
        container.appendChild(row);
      });
    }

    function renderMetrics() {
      const metrics = document.getElementById('metricsList');
      const total = allTasks.length;
      const blocked = allTasks.filter(t => t.blocked).length;
      const recurring = allTasks.filter(t => t.recurring).length;
      const review = allTasks.filter(t => t.column === 'review').length;
       const timeSpent = allTasks.reduce((sum, t) => sum + (Number(t.time_spent) || 0), 0);
       const today = new Date();
       const inSevenDays = new Date();
       inSevenDays.setDate(today.getDate() + 7);
       const dueThisWeek = allTasks.filter(t => {
         const d = t.due_date ? new Date(t.due_date) : null;
         return d && d >= today && d <= inSevenDays;
       }).length;
      metrics.innerHTML = `
        <div>üßæ Total: ${total}</div>
        <div>üü• Blocked: ${blocked}</div>
        <div>üîÑ Recurring: ${recurring}</div>
        <div>üìù Review: ${review}</div>
        <div>‚è±Ô∏è Time Spent: ${timeSpent.toFixed(1)}h</div>
        <div>üìÜ Due next 7d: ${dueThisWeek}</div>
      `;
    }

    function renderStrategic() {
      const roadmapContainer = document.getElementById('roadmapsList');
      if (roadmapContainer) {
        roadmapContainer.innerHTML = '';
        if (!roadmaps.length) {
          roadmapContainer.textContent = 'Roadmaps will live here.';
        } else {
          roadmaps.forEach(r => {
            const block = document.createElement('div');
            block.style.marginBottom = '16px';
            block.innerHTML = `<div style="font-weight:600; margin-bottom:4px;">${r.name}</div><div style="color:#9ca3af; font-size:12px; margin-bottom:8px;">${r.theme || ''}</div>`;
            const items = document.createElement('div');
            items.style.display = 'flex';
            items.style.flexDirection = 'column';
            items.style.gap = '6px';
            (r.items || []).forEach(item => {
              const card = document.createElement('div');
              card.className = 'task-card';
              card.style.cursor = 'pointer';
              card.style.padding = '10px 12px';
              card.style.background = '#1f2937';
              card.style.borderRadius = '6px';
              card.style.border = '1px solid #374151';
              card.style.transition = 'all 0.15s ease';
              card.onmouseenter = () => { card.style.borderColor = '#4b5563'; card.style.background = '#273549'; };
              card.onmouseleave = () => { card.style.borderColor = '#374151'; card.style.background = '#1f2937'; };
              card.onclick = () => openRoadmapItemDetail(r.id, item);
              const priorityColors = { P0: '#ef4444', P1: '#f97316', P2: '#3b82f6', P3: '#6b7280' };
              const pColor = priorityColors[item.priority] || '#6b7280';
              card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                  <span style="font-size:13px; color:#e5e7eb;">${item.title}</span>
                  <span style="font-size:11px; color:${pColor}; font-weight:600; margin-left:8px;">${item.priority || 'P2'}</span>
                </div>
                ${item.description ? `<div style="font-size:11px; color:#9ca3af; margin-top:4px;">${item.description.slice(0,60)}${item.description.length > 60 ? '...' : ''}</div>` : ''}
                <div style="font-size:10px; color:#6b7280; margin-top:6px;">${item.status || 'planned'}</div>
              `;
              items.appendChild(card);
            });
            block.appendChild(items);
            const addBtn = document.createElement('button');
            addBtn.className = 'filter-btn secondary';
            addBtn.style.marginTop = '8px';
            addBtn.style.fontSize = '12px';
            addBtn.textContent = '+ Add item';
            addBtn.addEventListener('click', () => addRoadmapItem(r.id));
            block.appendChild(addBtn);
            roadmapContainer.appendChild(block);
          });
        }
      }
    }

    // Agent Activity Dashboard
    async function refreshAgentActivity() {
      const agents = ['Ada', 'Spock', 'Scotty'];
      
      for (const agent of agents) {
        const agentLower = agent.toLowerCase();
        const statusEl = document.getElementById(`${agentLower}-status`);
        const taskEl = document.getElementById(`${agentLower}-task`);
        const logEl = document.getElementById(`${agentLower}-log`);
        
        // Find current task for this agent
        const currentTask = allTasks.find(t => t.assignee === agent && t.column === 'doing');
        const blockedTask = allTasks.find(t => t.assignee === agent && t.blocked);
        
        // Set status
        if (blockedTask) {
          statusEl.textContent = 'Blocked';
          statusEl.className = 'agent-status blocked';
        } else if (currentTask) {
          statusEl.textContent = 'Working';
          statusEl.className = 'agent-status working';
        } else {
          statusEl.textContent = 'Idle';
          statusEl.className = 'agent-status idle';
        }
        
        // Show current task
        if (currentTask) {
          taskEl.innerHTML = `<strong>Task #${currentTask.id}:</strong> ${currentTask.name}<br><small style="color:#666">Priority: ${currentTask.priority || 'P2'}</small>`;
        } else if (blockedTask) {
          taskEl.innerHTML = `<strong>‚ö†Ô∏è Task #${blockedTask.id}:</strong> ${blockedTask.name}<br><small style="color:#ef4444">${blockedTask.blocker_reason || 'Blocked'}</small>`;
        } else {
          taskEl.textContent = 'No active task';
        }
        
        // Load recent activity from session logs
        try {
          const activity = await apiFetch(`/api/agents/${agentLower}/activity`);
          if (activity.entries && activity.entries.length) {
            logEl.innerHTML = activity.entries.map(e => `
              <div class="agent-log-entry">
                <span class="agent-log-tool">${e.tool || e.action}</span>: ${(e.details || '').slice(0, 100)}${(e.details || '').length > 100 ? '...' : ''}
                <div class="agent-log-time">${getTimeAgo(e.timestamp)}</div>
              </div>
            `).join('');
          } else {
            logEl.innerHTML = '<div style="color:#555">No recent activity</div>';
          }
        } catch (e) {
          logEl.innerHTML = '<div style="color:#555">Could not load activity</div>';
        }
      }
    }

    function openRoadmapItemDetail(roadmapId, item) {
      const action = prompt(`"${item.title}"\n\nOptions:\n1. Promote to Task\n2. Edit\n3. Delete\n\nEnter 1, 2, or 3:`, '1');
      if (action === '1') {
        promoteToTask(roadmapId, item);
      } else if (action === '2') {
        editRoadmapItem(roadmapId, item);
      } else if (action === '3') {
        deleteRoadmapItem(roadmapId, item);
      }
    }

    async function promoteToTask(roadmapId, item) {
      const task = await apiFetch('/api/tasks', {
        method: 'POST',
        body: JSON.stringify({
          name: item.title,
          description: item.description || '',
          priority: item.priority || 'P2',
          column: 'backlog',
          created_by: 'Ada',
          assignee: 'Unassigned'
        })
      });
      await apiFetch(`/api/roadmap-items/${item.id}`, {
        method: 'PATCH',
        body: JSON.stringify({ status: 'in_progress', linked_task_id: task.id })
      });
      await loadTasks();
      await loadRoadmaps();
      renderStrategic();
      alert(`Created task: "${item.title}"`);
    }

    async function editRoadmapItem(roadmapId, item) {
      const newTitle = prompt('Title:', item.title);
      if (!newTitle) return;
      const newPriority = prompt('Priority (P0-P3):', item.priority || 'P2');
      const newDesc = prompt('Description:', item.description || '');
      await apiFetch(`/api/roadmap-items/${item.id}`, {
        method: 'PATCH',
        body: JSON.stringify({ title: newTitle, priority: newPriority, description: newDesc })
      });
      await loadRoadmaps();
      renderStrategic();
    }

    async function deleteRoadmapItem(roadmapId, item) {
      if (!confirm(`Delete "${item.title}"?`)) return;
      await apiFetch(`/api/roadmap-items/${item.id}`, { method: 'DELETE' });
      await loadRoadmaps();
      renderStrategic();
    }

    async function createRoadmap() {
      const name = document.getElementById('roadmapNameInput').value.trim();
      if (!name) return;
      await apiFetch('/api/roadmaps', { method: 'POST', body: JSON.stringify({ name }) });
      document.getElementById('roadmapNameInput').value = '';
      await loadRoadmaps();
      renderStrategic();
    }

    async function addRoadmapItem(roadmapId) {
      const title = prompt('Roadmap item title');
      if (!title) return;
      const priority = prompt('Priority (P0-P3)', 'P2') || 'P2';
      await apiFetch(`/api/roadmaps/${roadmapId}/items`, { method: 'POST', body: JSON.stringify({ title, priority }) });
      await loadRoadmaps();
      renderStrategic();
    }

    async function openTaskDetail(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;
      currentTaskId = taskId;

      // Auto-sync session logs in background for agent tasks
      const agentAssignees = ['Ada', 'Spock', 'Scotty'];
      if (agentAssignees.includes(task.assignee) && (task.column === 'doing' || task.column === 'review')) {
        autoSyncSessionLogs(task).catch(e => console.log('Auto-sync:', e.message));
      }

      document.getElementById('detailTaskName').value = task.name;
      document.getElementById('detailAssignee').value = task.assignee || 'Unassigned';
      document.getElementById('detailDueDate').value = task.due_date ? task.due_date.slice(0, 10) : '';
      document.getElementById('detailPriority').value = (task.priority || 'P2').toUpperCase();
      document.getElementById('detailColumn').value = task.column === 'complete' ? 'done' : task.column;
      document.getElementById('detailEstimate').value = task.estimate_hours || '';
      document.getElementById('detailTimeSpent').value = task.time_spent || '';
      document.getElementById('detailBlocked').checked = !!task.blocked;
      document.getElementById('detailBlockerReason').value = task.blocker_reason || '';
      document.getElementById('detailCreatedBy').textContent = `Created by ${task.created_by}`;
      document.getElementById('detailCreatedAt').textContent = `Created: ${new Date(task.created_at).toLocaleString()}`;
      document.getElementById('detailUpdatedAt').textContent = `Updated: ${new Date(task.updated_at).toLocaleString()}`;

      const descEl = document.getElementById('detailDesc');
      if (task.description) {
        descEl.textContent = task.description;
        descEl.style.display = 'block';
      } else {
        descEl.style.display = 'none';
      }

      renderDetailProjects(task);
      renderDependencies(task);
      renderAttachments(task);
      setActivityView(currentActivityView);
      setDetailTab('activity');
      loadComments(taskId);
      document.getElementById('taskDetailOverlay').classList.add('active');
    }

    function closeTaskDetail() {
      document.getElementById('taskDetailOverlay').classList.remove('active');
      document.getElementById('noteInput').value = '';
      document.getElementById('commentInput').value = '';
      currentTaskId = null;
    }

    function renderDetailProjects(task) {
      const container = document.getElementById('detailProjects');
      container.innerHTML = '';
      // Show selected projects as chips
      (task.projects || []).forEach(p => {
        const chip = document.createElement('span');
        chip.className = 'project-chip';
        chip.innerHTML = `${p.name} <span class="remove" onclick="removeProject(${task.id}, ${p.id})">√ó</span>`;
        container.appendChild(chip);
      });
      // Populate dropdown
      renderProjectDropdown(task);
    }

    function renderProjectDropdown(task) {
      const list = document.getElementById('projectDropdownList');
      const searchInput = document.getElementById('projectSearchInput');
      searchInput.value = '';
      list.innerHTML = '';
      const selectedIds = (task.projects || []).map(p => p.id);
      projects.filter(p => !selectedIds.includes(p.id)).forEach(p => {
        const item = document.createElement('div');
        item.className = 'project-dropdown-item';
        item.dataset.name = p.name.toLowerCase();
        item.innerHTML = `<span style="width:10px;height:10px;border-radius:50%;background:${p.color || '#6b7280'}"></span> ${p.name}`;
        item.onclick = () => addProject(task.id, p.id);
        list.appendChild(item);
      });
    }

    function toggleProjectDropdown() {
      document.getElementById('projectDropdownList').classList.toggle('show');
    }

    function filterProjects() {
      const search = document.getElementById('projectSearchInput').value.toLowerCase();
      const items = document.querySelectorAll('.project-dropdown-item');
      items.forEach(item => {
        item.style.display = item.dataset.name.includes(search) ? 'flex' : 'none';
      });
      document.getElementById('projectDropdownList').classList.add('show');
    }

    async function addProject(taskId, projectId) {
      const task = allTasks.find(t => t.id === taskId);
      const selectedIds = (task.projects || []).map(p => p.id);
      selectedIds.push(projectId);
      await apiFetch(`/api/tasks/${taskId}/projects`, {
        method: 'POST',
        body: JSON.stringify({ projectIds: selectedIds })
      });
      document.getElementById('projectDropdownList').classList.remove('show');
      await loadTasks();
      openTaskDetail(taskId);
    }

    async function removeProject(taskId, projectId) {
      const task = allTasks.find(t => t.id === taskId);
      const selectedIds = (task.projects || []).map(p => p.id).filter(id => id !== projectId);
      await apiFetch(`/api/tasks/${taskId}/projects`, {
        method: 'POST',
        body: JSON.stringify({ projectIds: selectedIds })
      });
      await loadTasks();
      openTaskDetail(taskId);
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.project-dropdown')) {
        document.getElementById('projectDropdownList')?.classList.remove('show');
      }
    });

    function renderDependencies(task) {
      const container = document.getElementById('detailDependencies');
      container.innerHTML = '';
      (task.dependencies || []).forEach(dep => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = `${dep.name || 'Task'} (#${dep.id})`;
        container.appendChild(chip);
      });
      document.getElementById('detailDependenciesInput').value = (task.dependencies || []).map(d => d.id).join(', ');
    }

    function renderAttachments(task) {
      const container = document.getElementById('detailAttachments');
      container.innerHTML = '';
      if (!task.attachments || !task.attachments.length) {
        container.innerHTML = '<div style="color:#6b7280; font-size:13px;">No attachments yet</div>';
        return;
      }
      task.attachments.forEach(att => {
        const link = document.createElement('a');
        link.href = att.path;
        link.textContent = att.name || att.path;
        link.target = '_blank';
        link.style.color = '#60a5fa';
        container.appendChild(link);
      });
    }

    async function addAttachment() {
      if (!currentTaskId) return;
      const name = document.getElementById('attachmentName').value.trim();
      const path = document.getElementById('attachmentPath').value.trim();
      if (!path) return;
      await apiFetch(`/api/tasks/${currentTaskId}/attachments`, {
        method: 'POST',
        body: JSON.stringify({ name, path })
      });
      document.getElementById('attachmentName').value = '';
      document.getElementById('attachmentPath').value = '';
      await loadTasks();
      openTaskDetail(currentTaskId);
    }

    async function saveDependencies() {
      if (!currentTaskId) return;
      const raw = document.getElementById('detailDependenciesInput').value || '';
      const ids = raw.split(',').map(v => Number(v.trim())).filter(Boolean);
      await apiFetch(`/api/tasks/${currentTaskId}/dependencies`, {
        method: 'POST',
        body: JSON.stringify({ dependsOn: ids })
      });
      await loadTasks();
      openTaskDetail(currentTaskId);
    }

    async function addNote() {
      const note = document.getElementById('noteInput').value.trim();
      if (!note || !currentTaskId) return;
      await apiFetch(`/api/tasks/${currentTaskId}/note`, {
        method: 'POST',
        body: JSON.stringify({ note, session_id: sessionId })
      });
      document.getElementById('noteInput').value = '';
      await loadTasks();
      openTaskDetail(currentTaskId);
    }

    function setDetailTab(tab) {
      currentDetailTab = tab;
      document.querySelectorAll('.detail-tab').forEach(button => button.classList.toggle('active', button.dataset.tab === tab));
      document.getElementById('detailActivityTab').classList.toggle('active', tab === 'activity');
      document.getElementById('detailCommentsTab').classList.toggle('active', tab === 'comments');
    }

    function setActivityView(view) {
      currentActivityView = view;
      document.querySelectorAll('.activity-view').forEach(button => button.classList.toggle('active', button.dataset.view === view));
      if (currentTaskId) {
        const task = allTasks.find(t => t.id === currentTaskId);
        if (task) renderActivityLog(task);
      }
    }

    async function syncSessionLogs() {
      if (!currentTaskId) return;
      const task = allTasks.find(t => t.id === currentTaskId);
      if (!task) return;

      // Find session_id from activity entries
      const sessionIds = (task.activity || [])
        .filter(a => a.session_id)
        .map(a => a.session_id);
      
      if (!sessionIds.length) {
        alert('No session IDs found in activity. Agents need to include session_id when logging.');
        return;
      }

      let totalSynced = 0;
      for (const sid of [...new Set(sessionIds)]) {
        try {
          const result = await apiFetch(`/api/tasks/${currentTaskId}/sync-session`, {
            method: 'POST',
            body: JSON.stringify({ session_id: sid })
          });
          totalSynced += result.synced || 0;
        } catch (e) {
          console.log(`Session ${sid} not found or failed:`, e.message);
        }
      }

      if (totalSynced > 0) {
        await loadTasks();
        openTaskDetail(currentTaskId);
        setActivityView('technical');
        alert(`Synced ${totalSynced} tool calls from Clawdbot sessions`);
      } else {
        alert('No new tool calls found to sync');
      }
    }

    // Auto-sync session logs (runs in background, no alerts)
    async function autoSyncSessionLogs(task) {
      // Try to find active session for this agent
      const agentSessions = {
        'Ada': 'main',
        'Spock': 'spock', 
        'Scotty': null, // Different gateway
      };

      const agentDir = agentSessions[task.assignee];
      if (!agentDir) return; // Scotty is on different machine

      // Get recent sessions for this agent
      try {
        const result = await apiFetch(`/api/tasks/${task.id}/auto-sync`, {
          method: 'POST',
          body: JSON.stringify({ agent: task.assignee, taskId: task.id })
        });
        
        if (result.synced > 0) {
          console.log(`Auto-synced ${result.synced} tool calls for task ${task.id}`);
          // Refresh the task data
          const tasks = await apiFetch('/api/tasks');
          allTasks = tasks;
          const updatedTask = allTasks.find(t => t.id === task.id);
          if (updatedTask && currentTaskId === task.id) {
            renderActivityLog(updatedTask);
          }
        }
      } catch (e) {
        // Silent fail for auto-sync
        console.log('Auto-sync failed:', e.message);
      }
    }

    function renderActivityLog(task) {
      const logEl = document.getElementById('detailActivityLog');
      logEl.innerHTML = '';
      const activity = (task.activity || []).filter(act => {
        const type = act.type || 'human';
        return currentActivityView === 'technical' ? type === 'technical' : type !== 'technical';
      });
      if (!activity.length) {
        if (currentActivityView === 'technical') {
          logEl.innerHTML = `<div style="color: #666; font-size: 13px;">
            No technical logs yet.<br><br>
            <em style="font-size: 12px;">Agents should log commands, outputs, and detailed progress here via:<br>
            POST /api/tasks/:id/activity with type: "technical"</em>
          </div>`;
        } else {
          logEl.innerHTML = `<div style="color: #666; font-size: 13px;">No activity yet</div>`;
        }
        return;
      }
      activity.forEach(act => {
        const time = new Date(act.created_at).toLocaleString();
        logEl.innerHTML += `
          <div class="activity-log-item">
            <div class="activity-dot ${act.action}"></div>
            <div style="flex: 1;">
              <strong>${act.user}</strong> ${act.action} ${act.details || ''}
            </div>
            <span style="font-size: 11px; color: #666;">${time}</span>
          </div>
        `;
      });
    }

    async function loadComments(taskId) {
      if (!taskId) return;
      const comments = await apiFetch(`/api/tasks/${taskId}/comments`);
      renderComments(comments);
    }

    function renderComments(comments) {
      const container = document.getElementById('detailCommentsList');
      container.innerHTML = '';
      if (!comments || comments.length === 0) {
        container.innerHTML = '<div style="color: #666; font-size: 13px;">No comments yet</div>';
        return;
      }
      const nodes = comments.map(comment => ({ ...comment, children: [] }));
      const byId = new Map(nodes.map(node => [node.id, node]));
      const roots = [];
      nodes.forEach(node => {
        if (node.parent_id) {
          const parent = byId.get(node.parent_id);
          if (parent) parent.children.push(node);
          else roots.push(node);
        } else roots.push(node);
      });
      roots.forEach(node => container.appendChild(renderCommentNode(node, 0)));
    }

    function renderCommentNode(comment, depth) {
      const wrapper = document.createElement('div');
      wrapper.className = 'comment-item';
      wrapper.style.marginLeft = `${depth * 16}px`;
      const created = new Date(comment.created_at).toLocaleString();
      wrapper.innerHTML = `
        <div class="comment-meta">
          <span>${comment.user}</span>
          <span>${created}</span>
        </div>
        <div class="comment-body"></div>
        <div class="comment-actions">Reply</div>
        <div class="comment-reply">
          <input type="text" placeholder="Write a reply..." />
          <button class="modal-btn primary">Send</button>
        </div>
      `;
      wrapper.querySelector('.comment-body').textContent = comment.body;
      const actions = wrapper.querySelector('.comment-actions');
      const replyBox = wrapper.querySelector('.comment-reply');
      const replyInput = replyBox.querySelector('input');
      actions.addEventListener('click', () => {
        replyBox.classList.toggle('active');
        replyInput.focus();
      });
      replyBox.querySelector('button').addEventListener('click', async () => {
        const body = replyInput.value.trim();
        if (!body) return;
        await addComment(comment.id, body);
        replyInput.value = '';
        replyBox.classList.remove('active');
      });
      if (comment.children?.length) {
        comment.children.forEach(child => wrapper.appendChild(renderCommentNode(child, depth + 1)));
      }
      return wrapper;
    }

    async function addComment(parentId = null, bodyOverride = null) {
      if (!currentTaskId) return;
      const inputEl = document.getElementById('commentInput');
      const body = bodyOverride || inputEl.value.trim();
      if (!body) return;
      await apiFetch(`/api/tasks/${currentTaskId}/comments`, {
        method: 'POST',
        body: JSON.stringify({ body, parent_id: parentId, session_id: sessionId })
      });
      if (!bodyOverride) inputEl.value = '';
      await loadComments(currentTaskId);
    }

    function toggleModal() {
      const modal = document.getElementById('modalOverlay');
      modal.classList.toggle('active');
      if (modal.classList.contains('active')) {
        document.getElementById('taskName').focus();
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById('taskDueDate').value = today;
      } else {
        document.getElementById('taskName').value = '';
        document.getElementById('taskDesc').value = '';
        document.getElementById('taskRecurring').checked = false;
        document.getElementById('taskEstimate').value = '';
      }
    }

    async function addTask() {
      const name = document.getElementById('taskName').value.trim();
      const description = document.getElementById('taskDesc').value.trim();
      const recurring = document.getElementById('taskRecurring').checked;
      const assignee = document.getElementById('taskAssignee').value;
      const due_date = document.getElementById('taskDueDate').value || new Date().toISOString().slice(0, 10);
      const priority = document.getElementById('taskPriority').value;
      const column = document.getElementById('taskColumn').value;
      const estimate_hours = document.getElementById('taskEstimate').value ? Number(document.getElementById('taskEstimate').value) : null;
      const projectIds = Array.from(document.querySelectorAll('#taskProjects input:checked')).map(cb => Number(cb.value));
      if (!name) return;
      await apiFetch('/api/tasks', {
        method: 'POST',
        body: JSON.stringify({ name, description, column, assignee, due_date, priority, recurring, projectIds, estimate_hours, session_id: sessionId })
      });
      toggleModal();
      loadTasks();
    }

    async function saveSimpleField(field, value) {
      if (!currentTaskId) return;
      const task = allTasks.find(t => t.id === currentTaskId);
      const wasBlocked = task?.blocked;
      
      await apiFetch(`/api/tasks/${currentTaskId}`, {
        method: 'PATCH',
        body: JSON.stringify({ [field]: value, session_id: sessionId })
      });
      
      // If we just unblocked a task, notify the agent
      if (field === 'blocked' && wasBlocked && !value) {
        notifyAgentUnblocked(currentTaskId, task);
      }
      
      await loadTasks();
      openTaskDetail(currentTaskId);
    }

    async function notifyAgentUnblocked(taskId, task) {
      // Log activity that task was unblocked
      await apiFetch(`/api/tasks/${taskId}/activity`, {
        method: 'POST',
        body: JSON.stringify({
          action: 'unblocked',
          user: currentUser?.username || 'Henry',
          details: 'Task unblocked - ready to continue',
          type: 'human'
        })
      });
      // Show confirmation
      console.log(`Task #${taskId} unblocked - agent ${task?.assignee} can continue`);
    }

    async function addCommentShortcut(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addComment();
      }
    }

    async function addNoteShortcut(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addNote();
      }
    }

    async function triggerContinue() {
      if (!currentTaskId) return;
      await apiFetch(`/api/tasks/${currentTaskId}/continue`, { method: 'POST', body: JSON.stringify({ session_id: sessionId }) });
      alert('Agent notified to continue work');
    }

    async function createFollowUp() {
      if (!currentTaskId) return;
      const name = prompt('Follow-up task name');
      if (!name) return;
      await apiFetch(`/api/tasks/${currentTaskId}/followup`, { method: 'POST', body: JSON.stringify({ name, session_id: sessionId }) });
      await loadTasks();
    }

    // Drag and drop
    document.querySelectorAll('.column').forEach(column => {
      column.addEventListener('dragover', (e) => e.preventDefault());
      column.addEventListener('drop', async (e) => {
        e.preventDefault();
        if (!draggedTask) return;
        const newColumn = column.dataset.column;
        const taskId = draggedTask.dataset.id;
        await apiFetch(`/api/tasks/${taskId}`, {
          method: 'PATCH',
          body: JSON.stringify({ column: newColumn, session_id: sessionId })
        });
        loadTasks();
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('taskDetailOverlay').classList.contains('active')) closeTaskDetail();
        else if (document.getElementById('settingsOverlay').classList.contains('active')) toggleSettings();
        else if (document.getElementById('modalOverlay').classList.contains('active')) toggleModal();
      }
    });

    document.getElementById('detailTaskName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); }
    });
    document.getElementById('detailTaskName').addEventListener('blur', (e) => {
      const name = e.target.value.trim();
      if (name) saveSimpleField('name', name);
    });
    document.getElementById('detailDueDate').addEventListener('change', (e) => saveSimpleField('due_date', e.target.value));
    document.getElementById('detailAssignee').addEventListener('change', (e) => saveSimpleField('assignee', e.target.value));
    document.getElementById('detailPriority').addEventListener('change', (e) => saveSimpleField('priority', e.target.value));
    document.getElementById('detailColumn').addEventListener('change', (e) => saveSimpleField('column', e.target.value));
    document.getElementById('detailEstimate').addEventListener('change', (e) => saveSimpleField('estimate_hours', e.target.value ? Number(e.target.value) : null));
    document.getElementById('detailTimeSpent').addEventListener('change', (e) => saveSimpleField('time_spent', e.target.value ? Number(e.target.value) : null));
    document.getElementById('detailBlocked').addEventListener('change', (e) => saveSimpleField('blocked', e.target.checked));
    document.getElementById('detailBlockerReason').addEventListener('blur', (e) => saveSimpleField('blocker_reason', e.target.value));
    document.getElementById('noteInput').addEventListener('keydown', addNoteShortcut);
    document.getElementById('commentInput').addEventListener('keydown', addCommentShortcut);

    document.getElementById('settingsArchiveToggle').addEventListener('change', (e) => setArchiveVisibility(e.target.checked));
    window.addEventListener('hashchange', () => initBoardFromHash());

    function initSettings() {
      const storedArchive = localStorage.getItem('mc_showArchive');
      if (storedArchive !== null) showArchive = storedArchive === 'true';
      setArchiveVisibility(showArchive);
    }

    function initBoardFromHash() {
      const hash = window.location.hash.replace('#', '');
      if (hash === 'strategic' || hash === 'ops' || hash === 'agents') setBoard(hash, false);
      else setBoard('ops', false);
    }

    async function boot() {
      const ok = await checkSession();
      if (!ok) return;
      await loadProjects();
      await loadRoadmaps();
      await loadTasks();
      await loadRecentActivity();
      setInterval(loadTasks, 5000);
      setInterval(loadRecentActivity, 8000);
    }

    initSettings();
    initInsights();
    initKanban();
    initBoardFromHash();
    boot();
  </script>
</body>
</html>
